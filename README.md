# RainBot.Channel

## О проекте

RainBot.Channel - это бот для Телеграма, который присылает уведомления о начале дождя в том или ином месте в телеграм канал.

### Стек

- **C#/.NET** для всего и **Python** для deployment-скриптов
- **Serverless YDB** для хранения данных
- **Yandex Cloud Functions** для выполнения кода, **Yandex Message Queue** для взаимодействия между функциями и **API Gateway** для разграничения с внешним миром
- **Terraform** для развертывания кода в Yandex Cloud
- **GitHub Actions** для автоматического развертывания кода из репозитория в Yandex Cloud

## Как устроен бот

Проект выглядит следующим образом:
![alt text](./docs/assets/bot-architecture.png)
Здесь есть пять функций:

- **TelegramHandler** - получает вебхуки от Телеграма. Поддерживает 3 типа комманд - /start, /stop и /info. Первые две отправляют запрос в очередь **subscription-handler-queue**, а третья сразу отправляет сообщение с информацией о боте. Также на неизвестные сообщения отправляется уведомление о том, что команда неизвестна.
- **SubscriptionHandler** - вызывается при помощи триггера в момент появления сообщения в очереди **subscription-handler-queue** и обрабатывает запрос на создание/удаление подписки пользователя из базы данных. После успешной/неуспешной обработки запроса отправляется ответ пользователю в **send-telegram-message-queue**.
- **YandexWeatherFetcher** - вызывается по крон-триггеру каждый час. Получает прогнозы от Яндекс.Погоды на следующие 12 часов и передаёт их в **forecast-handler-queue**.
- **ForecastHandler** - вызывается при помощи триггера в момент появления сообщения в очереди **forecast-handler-queue** и синхронизирует их с прогнозами из базы данных. Если среди прогнозов погоды найден дождь (или хуже), то берёт из базы подписки пользователей и посылает каждому сообщение о дожде.
- **SendTelegramMessage** - вызывается при помощи триггера в момент появления сообщения в очереди **send-telegram-message-queue** и отправляет сообщение пользователю в Телеграм.
